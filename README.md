## p2meg_analysis

最終解析用のコードを全員で統一的に管理するために作りました。

## Directory Structure

```text
p2meg_alalysis/
├── macros/        # ROOTマクロを配置するディレクトリ。解析処理の中心となるスクリプトを置く。
├── src/           # C++ の実装ファイル（.cc, .cpp）を置く。大きな処理やクラス定義の本体を記述する。
├── include/p2meg/ # ヘッダファイル（.h, .hh）。関数宣言やクラス宣言をまとめる。
├── data/          # 解析に使用する入力データ（実データ・シミュレーション等）を置く場所。ただし大容量データは Git には追加しない。
├── scripts/       # シェルスクリプト・バッチ処理など補助的なスクリプトを置く。
└── doc/           # 図・解析結果・メモなどを置くディレクトリ。出力ファイルもここ。
```

GitHub の仕様により空のディレクトリは表示されないため、ダミーファイルとして `.gitkeep` を入れてあります。

## コーディング規約（p2MEG 解析コード）

このセクションは、p2MEG 解析コードで「ミシェルスペクトル」と同じ流儀で関数群を追加していくための規約です。
他の作業者が ChatGPT 等を用いて実装する場合でも、この規約に従えば同じスタイルのコードが生成されることを目的とします。

---

### 全体に適用するルール

#### ディレクトリ構成

* 公開インターフェース（ヘッダ）は `include/p2meg/` に置く

  * 例：`include/p2meg/RMDSpectrum.h`
* 実装（.cc/.cpp）は `src/` に置く

  * 例：`src/RMDSpectrum.cc`
* ROOT マクロや実行用スクリプトは `macros/` や `scripts/` に置く（必要な場合のみ）
* 解析ノート・仕様・規約は `doc/` に置く

#### namespace の扱い

* **namespace は使わない**
* `.cc` 内部だけで使う補助関数は `static` で隠蔽する

  * 例：`static double BetaFromX(double x);`

#### 命名規則

* 定数名に **`k` 接頭辞は付けない**（`alpha`, `pi` のようにする）
* 関数名は「対象＋物理量」が分かる形にする

  * 例：`RMD_d3B_dxdy_dcos`, `Michel_dGamma_dx`
* 変数は物理で一般的な記号に合わせてよい（`x`, `y`, `beta`, `d` など）

  * ただしコメントで意味と単位を必ず書く

#### コメントと言語

* **コメントは日本語**
* 「何の式か」「どの近似か」「入力変数の定義」「単位」「注意点」を必ず書く

#### 単位と入力の約束

* エネルギー・質量の単位は原則 **MeV**
* 無次元化変数を使う場合は、定義を明記する

  * 例：`x = 2Ee/m_mu`, `y = 2Eγ/m_mu`

#### エラーハンドリング

* 解析用の軽量関数では例外は投げず、**不正入力・領域外は 0 を返す**を基本とする
* 数値不安定領域には **数値ガード**（例：`d_min`）を設けるが、それが「物理カットではない」ことをコメントで明記する

#### 依存関係

* 一般的な数値計算は標準ライブラリ（`<cmath>` など）で完結させる
* ROOT 依存は必要な場所に限定し、スペクトル核のような関数は ROOT 非依存を基本にする

---

### 解析用の便利関数（スペクトル・PDF核・補正関数など）を作るときのルール

#### “核（kernel）” と “PDF” を分ける

* まずは理論式そのものの **核**（例：`d^3B/dx dy dcos`）を実装する
* 尤度解析で使う **PDF（ウィンドウ内で積分して 1 に正規化された形）**は、核とは別に定義する（別関数でも、別モジュールでもよい）
* 核の関数コメントに「これは核であり、PDFとして使うなら正規化が必要」と必ず書く

#### 入出力インターフェースは最小

* 公開ヘッダ（`include/p2meg/*.h`）には必要最小限の関数宣言だけ置く
* `.cc` には内部補助関数（運動学チェック、補助量計算、係数計算など）を `static` で置く

#### 運動学領域チェック

* 物理的に許されない領域では **0 を返す**
* 領域条件は関数化して読みやすくする

  * 例：`static bool IsAllowedXY(double x, double y);`

#### 数値安定化（数値ガード）

* 共線極限などで `1/d`, `1/d^2` が大きくなる場合、`d_min` を引数で受け取り `d < d_min` のとき `d=d_min` とする
* コメントで必ず

  * 「これは数値ガードであり物理カットではない」
  * 「物理的な扱いは受容・分解能・閾値で決まる」
    を明記する

#### 発散・特異点・カット依存を明記

* 例：RMD の soft photon（`y -> 0`）で `1/y` 発散 → **`Eγ > Eγ_min` が必須**
* 規格化（ウィンドウ積分値）がカットに依存する場合、その旨を書く

#### 近似・物理モデルをファイル先頭にまとめる

* 例：

  * 「ツリーレベル SM(V-A)」
  * 「偏極項を無視（形状射影で平均される想定）」
  * 「高次補正なし」
* “どの条件でその近似が妥当か” も短く書く

  * 例：「受容が偏極軸に対して非対称だと偏極依存が残り得る」

#### 参考文献情報を残す

* 具体式の出典（論文名・式番号・Appendix 等）をコメントで残す

---

### `Constants.h` の運用ルール（何をどう追加するか）

#### 置いてよいもの（独立な定数のみ）

* 数学定数：`pi` など
* 基本結合定数：`alpha` など（定義が明確で独立）
* 既定の入力パラメータ：`kMassesPDG` のような「質量の入力値」（派生量ではない）

#### 置かないもの（派生量・依存量）

* 質量比や組み合わせ：`(m_e/m_mu)^2` のようなもの
* 質量ショートカット：`m_mu` を別名で切り出すようなもの
* 特定モジュールでしか使わない係数や便利量

これらは **各スペクトル実装（例：`RMDSpectrum.cc`）側で計算**する。

#### 追加手順

1. その値が「他の定数や入力（質量など）に依存しない」ことを確認する
2. 名前は **`k` 接頭辞を使わず**、小文字の分かりやすい名前にする（例：`alpha`, `pi`）
3. `inline constexpr` で追加し、コメントに「何の定数か」「必要なら出典」を書く

#### 追加例

```cpp
// 円周率
inline constexpr double pi = 3.14159265358979323846;

// 微細構造定数（PDG相当）
inline constexpr double alpha = 1.0 / 137.035999084;
```

---

### 新規モジュール追加のテンプレ手順

1. `include/p2meg/<Name>.h` を作る（公開関数の宣言、入出力定義、注意点コメント）
2. `src/<Name>.cc` を作る（内部補助関数 `static`、実装、数値ガード、領域チェック）
3. `Constants.h` に独立定数が足りなければ追加（派生量は追加しない）
4. 簡単な呼び出しテストで sanity check をする

---